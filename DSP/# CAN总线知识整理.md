# CAN总线知识整理
## 1.CAN总线知识基础
### 1.1 CAN2.0B协议
CAN总线中，报文传输由以下四个不同的帧类型来表示和控制：
* 数据帧：将数据从发送器传输到接收器
* 远程帧：总线单元发送出远程帧，请求其他单元发送具有同一标识符的数据帧。
* 错误帧：任何单元检测到总线错误就发送错误帧
* 过载帧：在帧与帧之间插入适当的延时，是的帧与帧之间保持一定的距离。

数据帧和远程帧可以使用标准帧和扩展帧两种格式。
#### 1.1.1 CAN总线帧格式
**数据帧的格式如下：**
数据帧由七个不同的场位组成：帧起始、仲裁场、控制场、数据场、CRC场、应答场、帧结尾。
如下图所示：
![](https://cdn.jsdelivr.net/gh/Yetsang/PicBed2/img/%E6%88%AA%E5%B1%8F2021-09-28%20%E4%B8%8A%E5%8D%8810.31.16.png)

* 帧起始：标志数据帧和远程帧的开始，由一个“**显性**”位组成。
* 仲裁场：
  * 标准格式:11位标识符和RTR位；
    * 标识符：ID28~ID18，最低位ID18。7个最高位ID28~ID22**不能全是隐性**。
    * RTR：远程发送请求位，在数据帧里必须为**显性**，远程帧里必须为**隐性**。即，**RTR位在数据帧里必须为0，而在远程帧里必须为1**。
  * 扩展格式:29位标识符、SRR位、IDE位和RTR位
    * 标识符：11位基本ID和18位扩展ID。
    * 首先发送基本ID,其次是IDE位和SRR位，然后是扩展ID，最后是RTR位。
    * SRR:替代远程请求位，隐性位，在扩展格式的标准帧RTR位置，标准帧和扩展帧出现冲突时，标准帧优先于扩展帧。
    * IDE全称为标识符扩展位，位于标准格式的控制场，扩展格式的仲裁场。标准格式中的IDE为**显性**，扩展格式中的IDE为**隐性**。即，**标准格式中，IDE为0；扩展格式中，IDE为1**。
![](https://cdn.jsdelivr.net/gh/Yetsang/PicBed2/img/%E6%88%AA%E5%B1%8F2021-09-28%20%E4%B8%8A%E5%8D%8811.08.36.png)
* 控制场：
  * 标准格式：数据长度代码、IDE位及保留位r0;
  * 扩展格式：数据长度代码、保留位r0,r1。
  * 数据长度代码指示了数据场里的字节数量，数据长度代码为4位，取值范围为0~8。
![](https://cdn.jsdelivr.net/gh/Yetsang/PicBed2/img/%E6%88%AA%E5%B1%8F2021-09-28%20%E4%B8%8A%E5%8D%8811.10.25.png)
* 数据场：
  可以为0~8字节，每字节8位。首先发送MSB位。
* CRC场：由CRC序列和CRC界定符组成。循环冗余校验。CRC序列由CAN控制器自动计算，无须人工计算。
* 应答场：
  * 应答间隙
  * 应答界定符
  * 应答场中，发送器发送两个隐性位，接收器正确地接收到有效的报文，接收器就会在应答间隙起见向发送器发送一个“显性”的位应答。应答界定符是应答场的第二个位，并且是一个必须为隐性的位，因此，应答间隙被两个隐性的位所包围，也就是CRC界定符和应答界定符。
* 帧结尾：标志序列，7个隐性位组成。
**远程帧的格式如下：**
包括：帧起始、仲裁场、控制场、CRC场、应答场、帧结尾。
![](https://cdn.jsdelivr.net/gh/Yetsang/PicBed2/img/%E6%88%AA%E5%B1%8F2021-09-28%20%E4%B8%8A%E5%8D%8811.16.50.png)

**错误帧的格式如下：**
包括：
* 不同节点提供的错误标志的叠加
  * 主动错误标志：6个连续显性位
  * 被动错误标志：6个连续隐性位
* 错误界定符
  8个隐性位

**过载帧的格式如下：**
* 过载标志
* 过载界定符
  
**帧间空间：**
数据帧与先行帧的隔离是通过帧间空间实现的。过载帧与错误帧之前没有帧间空间。
帧间空间包括间歇和总线空闲两种位场。 
* 间歇：3个隐性位。间歇起见，所有的站均不允许传送数据帧或远程帧，唯一要做的是标识一个过载条件。

#### 1.1.2 CAN总线通信错误处理
五种错误类型：
* 位错误：发送的位值与所监视的位值不同。
* 填充错误：如果使用位填充法进行编码的信息中，出现第6个连续相同的位电平时，将检测到一个填充错误。
* CRC错误：CRC计算错误
* 形式错误：一个固定形式的位场中含有1个或多个非法位时，检测到一个形式错误。
* 应答错误：只要在应答间隙起见所见识的位不为显性，则发送器检测到一个应答错误。

三种故障状态：错误主动、错误被动和离线。依次加重。为界定故障状态，每个节点设有发送错误计数器和接受错误计数器。

#### 1.1.3 CAN总线的位定时要求：
标称速率：一个理想的发送器在**没有重新同步**的情况下每秒所发送的位数量称为标称位速率
标称时间：发送每一个位所需要花费的时间称为标称位时间。标称位时间 = 1/标称位速率

标称时间划分：
* 同步段：位时间的同步段用于同步总线上的不同节点。本段内要有一个跳变沿。
* 相位缓冲段1、相位缓冲段2：补偿边沿阶段的误差，可以通过重新同步加长或缩短。
* 传播时间段：用于补偿网络内的物理延时时间。是总线上输入比较器延时和输出驱动器延时总和的两倍。
![](https://cdn.jsdelivr.net/gh/Yetsang/PicBed2/img/%E6%88%AA%E5%B1%8F2021-09-28%20%E4%B8%8B%E5%8D%883.53.55.png)

其他和标称时间相关的概念：
采样点：采样点是去读总线上的电平并解释各位的值的一个时间点，位于相位缓冲段1之后。
信息处理时间：信息处理时间是一个以采样点作为其实的时间段，采样点用于计算后续位的位电平。
时间份额：时间份额是产生于振荡器周期的固定时间单元。存在一个可编程的预比例因子：
![](https://cdn.jsdelivr.net/gh/Yetsang/PicBed2/img/%E6%88%AA%E5%B1%8F2021-09-28%20%E4%B8%8B%E5%8D%884.01.40.png)

时间段的长度：（时间份额）
同步段：1；
传播段：1~8；
相位缓冲段1：1~8；
相位缓冲段2：相位缓冲段1和信息处理时间之间的最大值。
信息处理时间：<=2;
一个位时间总的时间份额值可以设置在8~25范围内。

#### 1.1.4 CAN总线的位仲裁
CAN总线采用的是一种称为”载波检测，多主掌控/冲突避免（CSMA/CA）的通信模式。
当总线处于空心啊状态是呈隐性电平，此时任何节点都可以向总线发送显性电平作为帧的开始。如果2个或2个以上的节点同事发送就会产生竞争。CAN总线的解决方法是：按位对标识符进行仲裁。各节点在想总线发送电平的同时，也对总线上的电平读取，并与自身的电平进行比较。如果电平相同，则继续发送下一位，如果不同则停止发送并退出总线竞争。剩余的节点继续上述过程，直到总线上只剩下一个节点发送的电平，总线竞争结束。优先级高的节点获得了总线的控制权。
CAN总线以报文位单位进行数据传输，报文的优先级结合在11位或29位的标识符中，**具有最低二进制数的标识符拥有最高的优先级**。

### 1.2 X281X eCAN模块内容
#### 1.2.1 eCAN模块的结构
eCAN模块主要由CAN协议内核CPK和消息控制器构成。
用户不用关注CPK，因为无法通过代码对其进行访问。
消息控制器包括：
* 存储器管理单元：包括CPU接口，控制单元和定时器管理单元。
* 32个邮箱存储器，每个邮箱具有4x32位空间。
* 控制和状态寄存器。
消息控制器的作用是负责决定是否保存由CPK接收到的消息，供CPU使用或者丢弃，同时也负责根据消息的优先级来讲消息发送给CPK。
接收时：CPK接收到有效的消息后，消息控制器的接收单元确定是否讲接收到的消息存储到邮箱存储器中。接收控制单元根据**消息的状态、标识符和所有消息对象的滤波**来确定相应邮箱的位置。如果不能找到春芳接收消息的有效地址，接收到的消息将会被丢弃。

发送时：消息控制器讲CPU要发送的消息传送到CPK的发送缓冲，以便在下一个总线空闲状态开始发送该消息。当有多个消息需要发送时，消息控制器将根据这些消息的**优先级**对其进行排队，若两个发送邮箱需要发送的消息具有相同的优先级，则首先将编号大的邮箱内所放的消息发送出去。

**这里引入一个问题，消息的优先级是根据什么判断的？**

#### 1.2.2 eCAN模块的存储空间
第一段地址：分配给控制寄存器、状态寄存器、接收滤波器、定时邮递和消息对象超时等。
第二段地址：分配给32个邮箱。
![](https://cdn.jsdelivr.net/gh/Yetsang/PicBed2/img/%E6%88%AA%E5%B1%8F2021-09-28%20%E4%B8%8B%E5%8D%884.57.50.png)

#### 1.2.3 eCAN模块的邮箱
32个，共占512字节的存储空间，每个邮箱16字节存储空间。






